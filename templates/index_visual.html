<html>
<head>
    <title>Visualize the Detection</title>
    <script src="static/js/jquery-3.1.0.min.js"></script>
</head>
<body>
The Video
<br/>
<div id="message"></div>
<input type="file" accept="video/*"/>
<video id="my_video" controls>

</video>
<br/>
The Canvas
<br/>
<canvas id="thecanvas">
</canvas>
<br/>
The Image
<br/>
<img id="thumbnail_img" alt="Right click to save"/>
<br/>


<form id="form_detect" action="create_test" method="POST"
      enctype="multipart/form-data">
    <input hidden name="long_running" value="false">
    <input hidden name="format" value="img">
    <div class="form-group form-inline">
        <input id="confidence" type="number" name="confidence" step="0.01"
               class="form-control time_remains"
               value="0.5"><br>
    </div>
    <input id="image_upload" type="file" name="detect_file" multiple class="form-control">
</form>


</body>
<script type='text/javascript'>

    window.onload = function () {

        var video = document.getElementById('my_video');
        var thecanvas = document.getElementById('thecanvas');
        var img = document.getElementById('thumbnail_img');

        video.addEventListener('timeupdate', function () {
            draw(video, thecanvas, img);
        });
    };

    function draw(video, thecanvas, img) {
        // get the canvas context for drawing
        var context = thecanvas.getContext('2d');
        // draw the video contents into the canvas x, y, width, height
        context.drawImage(video, 0, 0, thecanvas.width, thecanvas.height);
        // get the image data from the canvas object
        var dataURL = thecanvas.toDataURL();
        // set the source of the img tag
        img.setAttribute('src', dataURL);

        //begin request
        $.ajax({
            type: 'POST',
            url: 'http://cloudlet015.elijah.cs.cmu.edu:6000/detect',
            data:{
                confidence: '0.5',
                format: 'box',
                file: dataURL,
            }
        }).done(function(data){
            console.log('request result ' + data)
        })
    }


    var URL = window.URL || window.webkitURL
    var displayMessage = function (message, isError) {
        var element = document.querySelector('#message')
        element.innerHTML = message
        element.className = isError ? 'error' : 'info'
    }
    var playSelectedFile = function (event) {
        var file = this.files[0]
        var type = file.type
        var videoNode = document.querySelector('video')
        var canPlay = videoNode.canPlayType(type)
        if (canPlay === '') canPlay = 'no'
        var message = 'Can play type "' + type + '": ' + canPlay
        var isError = canPlay === 'no'
        displayMessage(message, isError)

        if (isError) {
            return
        }

        var fileURL = URL.createObjectURL(file)
        videoNode.src = fileURL
    }
    var inputNode = document.querySelector('input')
    inputNode.addEventListener('change', playSelectedFile, false)
</script>
</html>
